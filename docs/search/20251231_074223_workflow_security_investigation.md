# 追加調査報告: 変数の維持範囲とセキュリティについて

先の調査に基づき、実施した検証結果と推奨事項を報告します。

## 1. 変数のスコープ（維持範囲）

**検証結果: シェルセッションは「維持」されています（PIDが同一）。**

`run_command` ツールの挙動を検証したところ、連続するコマンド実行でプロセスID（PID）が変わらないことが確認されました。
これは、エージェントが**単一の継続したシェルセッション**を使用していることを意味します。

- **挙動**: Step 1で `export VAR=1` を行うと、Step 2以降でも `$VAR` は参照可能です。
- **リスク**: この挙動はエージェントの実装（ツールの裏側の仕組み）に依存しており、将来的に「ステップごとに新しいシェルを起動する」仕様に変更された場合、ワークフローが動かなくなる可能性があります。

**推奨**:
仕様変更への堅牢性を高めるため、**「各ステップで都度 `source` する（またはワンライナーで繋ぐ）」アプローチを強く推奨**します。これによるオーバーヘッドは無視できるレベルです。

```bash
# 安全な記述例（1行で完結させる）
source .agent/config.env && ./myscript.sh
```

## 2. セキュリティとログ

**検証結果: エージェントの履歴（ログ）には残らないが、OSレベルでは一時的に見える可能性があります。**

### A. エージェントのログ・Artifact（安全）
ワークフロー定義ファイルに `$API_KEY` と記述し、それを `source` した環境変数で解決する場合：
- **入力ログ**: `curl -H "Auth: $API_KEY" ...` という**文字列（変数名のまま）**が記録されます。**平文のキーは記録されません。**
- **出力ログ**: コマンド自体がキーを標準出力（stdout）に表示しない限り、記録されません。

### B. OSのプロセスリスト（注意）
コマンド実行の一瞬ですが、`ps` コマンド等でプロセスを見た際、引数が展開された状態で表示されるリスクがあります。
- **危険**: `curl -H "Auth: freee_12345..." https://api.example.com` （引数で渡す）
- **安全**: 環境変数から直接読み込むアプリケーションを実行する、または標準入力から渡す。

**推奨される記述方法**:
変数を引数として展開せず、**環境変数として渡す**形にします。
```bash
# 良い例（変数はサブプロセスに環境変数として渡るのみ）
source .agent/config.env && DURATION=30 ./run_batch_process.sh

# 許容範囲（curlなど引数必須な場合）
# エージェントログには "$KEY" と残るため、あとで見返しても安全。
source .agent/config.env && curl -H "Authorization: Bearer $API_KEY" https://...
```
※ `echo $API_KEY` のようなデバッグコマンドは絶対に残さないでください。

## 3. 記述の簡略化（DRY）

毎回 `source ...` を書く冗長さを回避するためのテクニックを提案します。

### A. ヘルパースクリプトの利用（推奨）
プロジェクト固有のラッパースクリプトを作成し、そこで設定読み込みを共通化します。

**1. ラッパー作成 (`.agent/run.sh`):**
```bash
#!/bin/bash
# 設定を読み込む
[ -f .agent/config.env ] && source .agent/config.env
# 引数のコマンドを実行
exec "$@"
```
`chmod +x .agent/run.sh` しておきます。

**2. ワークフロー定義:**
```markdown
# 記述が短く、意図も明確になる
.agent/run.sh curl https://api.example.com/endpoint
.agent/run.sh ./scripts/deploy.sh
```

この方法であれば、設定ファイルのパス変更や読み込みロジックの変更があっても、`run.sh` 1箇所の修正で済みます。

---

## 総合的な推奨構成

1.  **設定ファイル**: `.agent/config.env` （Git対象外）
2.  **実行ラッパー**: `.agent/run.sh` （Git対象・上記スクリプト）
3.  **ワークフロー定義**: 全てのコマンドを `.agent/run.sh <command>` 経由で実行する。

この構成により、**「環境依存の分離」「セキュリティ（ログ隠蔽）」「記述の簡略化」「将来の仕様変更への耐性」**全てをバランスよく満たすことができます。
