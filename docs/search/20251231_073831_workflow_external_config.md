# 調査報告: ワークフロー定義ファイルからの外部設定ファイル読み込みの可否

ご依頼いただいた「ワークフロー定義ファイルから環境依存情報を分離し、設定ファイルとして読み込む」設計について、技術的な検証を行いました。

## 調査結果サマリ

- **実現可能性**: **可能**です。
- **推奨方式**: **`.env` 形式（シェル変数定義）のファイルを `source` コマンドで読み込む**方法が最も確実かつシンプルです。
- **JSON形式**: 環境に `jq` コマンドが存在しないため、パースのために Python や Node.js のワンライナーを併用する必要があり、記述が複雑になります。

---

## 1. ワークフロー内からの読み込み権限とパス解決

### 権限

ワークフロー（`run_command`）はユーザー権限でシェル（zsh）を実行するため、プロジェクトルート内のファイルであれば問題なく読み取り可能です。

### パース解決

`run_command` のカレントディレクトリ（`Cwd`）は通常プロジェクトルートに設定されます。したがって、ルートからの相対パス（例: `.agent/config.env`）で確実にアクセス可能です。

## 2. 推奨されるファイル形式と読み込み方法

### 【推奨】 `.env` (Shell Script) 形式

最も互換性が高く、追加ツール不要で動作します。

**設定ファイル例 (`.agent/config.env`):**

```bash
TARGET_DIR="/absolute/path/to/target"
API_KEY="secret_value"
```

**ワークフロー定義内での読み込み例:**

```markdown
# 読み込んで変数を利用するステップ

source .agent/config.env && echo "Target is $TARGET_DIR"
```

_検証結果: `source` コマンドにより正常に変数が展開されることを確認しました。_

### 【非推奨・要工夫】 JSON 形式

環境に `jq` コマンドがインストールされていないことが確認されました (`command not found: jq`)。JSONを採用する場合、以下のように標準搭載のランタイム（Pythonなど）を利用してパースする必要があります。

**読み込み例 (Python利用):**

```bash
CONFIG_VAL=$(python3 -c "import json; print(json.load(open('.agent/config.json'))['key'])")
```

記述が冗長になるため、特別な理由がない限り `.env` 形式を推奨します。

## 3. エラー回避と注意点

### 設定ファイルが見つからない場合のリスク

`source` コマンドはファイルが見つからないとエラーを出力しますが、後続のコマンドが意図せず（変数が空のまま）実行されるリスクがあります。
以下のように「ファイル存在確認」を入れることを推奨します。

```bash
if [ -f .agent/config.env ]; then
  source .agent/config.env
else
  echo "Error: Config file not found."
  exit 1
fi
```

### Git管理外ファイルの取り扱い

提案通り `.gitignore` に設定ファイルを含めることで、リポジトリを汚さずにローカル設定を保持できます。
チーム開発の場合は、設定のテンプレート（例: `.agent/config.sample.env`）をGit管理下に置き、利用者はそれをコピーして使う運用にするとスムーズです。

## 結論

提案された設計は実現可能です。
**`.env` 形式の設定ファイルを作成し、ワークフローの各ステップの冒頭で `source` する**構成を採用してください。
